{% extends 'base.html' %}

{% block content %}

<div x-data="shopPage()" class="pb-24 pt-4">
    
    <!-- Items data - safely embedded as JSON -->
    <script type="application/json" id="shop-items-data">
        {{ items_json|safe }}
    </script>
    
    <!-- 1. هدر و جستجو -->
    <div class="sticky top-16 z-30 bg-[#050510]/95 backdrop-blur-xl py-2 -mx-4 px-4 border-b border-gray-800/50 mb-6">
        <div class="relative">
            <input type="text" x-model="searchQuery" @input.debounce.300ms="filterItems()" 
                   placeholder="جستجوی تجهیزات..." 
                   class="w-full bg-gray-900 border border-gray-700 text-white text-sm rounded-xl py-3 pr-10 pl-4 focus:outline-none focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500 transition-all placeholder-gray-600 shadow-inner">
            <i class="fas fa-search absolute top-3.5 right-3.5 text-gray-500"></i>
        </div>

        <!-- 2. تب‌بندی (Categories) -->
        <div class="flex gap-2 mt-3 overflow-x-auto no-scrollbar pb-1">
            <button @click="category = 'ALL'; filterItems()" 
                    class="px-4 py-1.5 rounded-lg text-xs font-bold transition-all border whitespace-nowrap"
                    :class="category === 'ALL' ? 'bg-cyan-500/20 border-cyan-500 text-cyan-400 shadow-[0_0_10px_rgba(6,182,212,0.3)]' : 'bg-gray-800 border-gray-700 text-gray-400 hover:bg-gray-700'">
                همه
            </button>
            <button @click="category = 'MINER'; filterItems()" 
                    class="px-4 py-1.5 rounded-lg text-xs font-bold transition-all border whitespace-nowrap"
                    :class="category === 'MINER' ? 'bg-green-500/20 border-green-500 text-green-400 shadow-[0_0_10px_rgba(34,197,94,0.3)]' : 'bg-gray-800 border-gray-700 text-gray-400 hover:bg-gray-700'">
                <i class="fas fa-server mr-1"></i> ماینر
            </button>
            <button @click="category = 'SKIN'; filterItems()" 
                    class="px-4 py-1.5 rounded-lg text-xs font-bold transition-all border whitespace-nowrap"
                    :class="category === 'SKIN' ? 'bg-yellow-500/20 border-yellow-500 text-yellow-400 shadow-[0_0_10px_rgba(234,179,8,0.3)]' : 'bg-gray-800 border-gray-700 text-gray-400 hover:bg-gray-700'">
                <i class="fas fa-mask mr-1"></i> اسکین
            </button>
            <button @click="category = 'AVATAR'; filterItems()" 
                    class="px-4 py-1.5 rounded-lg text-xs font-bold transition-all border whitespace-nowrap"
                    :class="category === 'AVATAR' ? 'bg-purple-500/20 border-purple-500 text-purple-400 shadow-[0_0_10px_rgba(168,85,247,0.3)]' : 'bg-gray-800 border-gray-700 text-gray-400 hover:bg-gray-700'">
                <i class="fas fa-user-circle mr-1"></i> آواتار
            </button>
            <button @click="category = 'BUFF'; filterItems()" 
                    class="px-4 py-1.5 rounded-lg text-xs font-bold transition-all border whitespace-nowrap"
                    :class="category === 'BUFF' ? 'bg-red-500/20 border-red-500 text-red-400 shadow-[0_0_10px_rgba(239,68,68,0.3)]' : 'bg-gray-800 border-gray-700 text-gray-400 hover:bg-gray-700'">
                <i class="fas fa-sparkles mr-1"></i> باف
            </button>
        </div>
    </div>

    <!-- Loading State -->
    <div x-show="loading" class="flex justify-center py-20">
        <i class="fas fa-spinner fa-spin text-4xl text-cyan-500"></i>
    </div>

    <!-- 3. شبکه محصولات -->
    <div class="grid grid-cols-2 gap-4" x-show="!loading">
        <template x-for="item in filteredItems" :key="item.id">
            <div class="relative group bg-gray-900 border border-gray-800 rounded-xl overflow-hidden hover:border-gray-600 transition-all duration-300 animate-bounce-in"
                 :class="{'grayscale opacity-75': item.stock === 0}">
                
                <!-- بج موجودی (Stock Badge) -->
                <div class="absolute top-2 left-2 z-10">
                    <template x-if="item.stock === -1">
                        <div class="badge badge-success badge-xs gap-1 font-bold shadow-[0_0_5px_lime]">
                            <i class="fas fa-infinity text-[8px]"></i> نامحدود
                        </div>
                    </template>
                    <template x-if="item.stock === 0">
                        <div class="badge badge-error badge-xs font-bold shadow-[0_0_5px_red]">
                            تمام شد
                        </div>
                    </template>
                    <template x-if="item.stock > 0">
                        <div class="badge badge-warning badge-xs font-bold">
                            <span x-text="item.stock"></span> عدد
                        </div>
                    </template>
                </div>

                <!-- بج کد آیتم -->
                <div class="absolute top-2 right-2 z-10 opacity-0 group-hover:opacity-100 transition-opacity">
                    <span class="text-[8px] bg-black/80 px-1.5 py-0.5 rounded text-gray-400 border border-gray-700 font-mono" x-text="item.item_code"></span>
                </div>

                <!-- تصویر محصول -->
                <div class="h-32 w-full bg-gradient-to-b from-gray-800/50 to-transparent flex items-center justify-center p-4 relative group-hover:bg-gray-800/80 transition-colors">
                    <div class="absolute inset-0 bg-cyan-500/5 blur-xl rounded-full scale-50 group-hover:scale-75 transition-transform duration-500"></div>
                    
                    <template x-if="item.image_url">
                        <img :src="item.image_url" class="h-full w-full object-contain drop-shadow-lg group-hover:scale-110 transition-transform duration-300">
                    </template>
                    <template x-if="!item.image_url">
                        <i class="fas fa-box-open text-5xl text-gray-700"></i>
                    </template>
                </div>
                
                <!-- اطلاعات محصول -->
                <div class="p-3">
                    <h3 class="font-bold text-sm text-gray-200 truncate" x-text="item.name"></h3>
                    
                    <!-- مشخصات فنی (بر اساس نوع) -->
                    <div class="h-6 mt-1">
                        <template x-if="item.item_type === 'MINER'">
                            <div class="text-[10px] text-gray-500 flex items-center gap-1">
                                <i class="fas fa-tachometer-alt text-yellow-600"></i>
                                <span dir="ltr">Power: <span x-text="item.mining_rate"></span>/h</span>
                            </div>
                        </template>
                        <template x-if="item.item_type === 'SKIN'">
                            <div class="text-[10px] text-purple-400">Skin Item</div>
                        </template>
                        <template x-if="item.item_type === 'BUFF'">
                            <div class="text-[10px] text-red-400">
                                <template x-if="item.buff_click_coins > 0">
                                    <span><i class="fas fa-hand-pointer"></i> +<span x-text="item.buff_click_coins"></span></span>
                                </template>
                                <template x-if="item.buff_mining_speed > 0">
                                    <span class="mr-2"><i class="fas fa-gem"></i> +<span x-text="item.buff_mining_speed"></span>%</span>
                                </template>
                            </div>
                        </template>
                    </div>

                    <!-- فوتر: قیمت و دکمه -->
                    <div class="flex items-center justify-between mt-3 pt-3 border-t border-gray-800">
                        <div class="text-xs font-bold text-yellow-400 flex items-center gap-1 drop-shadow-sm">
                            <span x-text="item.price_diamonds"></span> <i class="fas fa-gem text-[10px]"></i>
                        </div>
                        
                        <button @click="buyItem(item)" 
                                class="btn btn-xs px-4 transition-all"
                                :class="item.stock === 0 ? 'btn-disabled bg-gray-800 text-gray-600' : 'btn-primary shadow-[0_0_10px_rgba(6,182,212,0.4)] hover:scale-105'">
                            <template x-if="item.stock === 0">
                                <span><i class="fas fa-lock"></i></span>
                            </template>
                            <template x-if="item.stock !== 0">
                                <span>خرید</span>
                            </template>
                        </button>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- Empty State -->
    <div x-show="filteredItems.length === 0 && !loading" class="text-center py-20 text-gray-500">
        <i class="fas fa-search text-4xl mb-4 opacity-20"></i>
        <p>آیتمی پیدا نشد</p>
    </div>

</div>

<!-- Game API -->
<script src="/static/game/js/api.js"></script>

<script>
    function shopPage() {
        return {
            items: [],
            loading: false,
            category: 'ALL',
            searchQuery: '',
            
            init() {
                // Load items from embedded data
                const dataElement = document.getElementById('shop-items-data');
                if (dataElement) {
                    this.items = JSON.parse(dataElement.textContent);
                }
            },
            
            get filteredItems() {
                let result = this.items;
                
                // Filter by category
                if (this.category !== 'ALL') {
                    result = result.filter(item => item.item_type === this.category);
                }
                
                // Filter by search query
                if (this.searchQuery) {
                    const query = this.searchQuery.toLowerCase();
                    result = result.filter(item => 
                        item.name.toLowerCase().includes(query) ||
                        (item.item_code && item.item_code.toLowerCase().includes(query))
                    );
                }
                
                return result;
            },
            
            filterItems() {
                // Filtering is done reactively in the getter
            },
            
            async buyItem(item) {
                // ویبره برای موبایل
                if (navigator.vibrate) navigator.vibrate(10);
                
                if(!confirm(`آیا از خرید ${item.name} مطمئن هستید؟`)) return;
                
                this.loading = true;
                
                try {
                    const result = await gameAPI.buyItem(item.id);
                    showToast(result.message, result.status === 'success' ? 'success' : 'error');
                    
                    if(result.status === 'success') {
                        setTimeout(() => location.reload(), 1000);
                    }
                } catch (error) {
                    showToast(error.message || 'خطا در خرید', 'error');
                } finally {
                    this.loading = false;
                }
            }
        }
    }
</script>

<style>
    /* مخفی کردن اسکرول بار در تب‌ها */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
</style>
{% endblock %}
